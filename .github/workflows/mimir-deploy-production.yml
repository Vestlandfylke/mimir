name: Deploy Mimir to Production

on:
  push:
    branches:
      - main
    paths:
      - "webapi/**"
      - "webapp/**"
      - "mcp-bridge/**"
      - "memorypipeline/**"
      - ".github/workflows/*.yml"
  workflow_dispatch:
    inputs:
      deploy_mcp_bridge:
        description: "Deploy MCP Bridge"
        required: false
        type: boolean
        default: true
      deploy_backend:
        description: "Deploy Backend"
        required: false
        type: boolean
        default: true
      deploy_frontend:
        description: "Deploy Frontend"
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  id-token: write

jobs:
  # Build backend
  build-backend:
    if: github.event.inputs.deploy_backend != 'false'
    uses: ./.github/workflows/copilot-build-backend.yml

  # Build frontend
  build-frontend:
    if: github.event.inputs.deploy_frontend != 'false'
    uses: ./.github/workflows/copilot-build-frontend.yml

  # Build memorypipeline
  build-memorypipeline:
    uses: ./.github/workflows/copilot-build-memorypipeline.yml

  # Build MCP bridge
  build-mcp-bridge:
    if: github.event.inputs.deploy_mcp_bridge != 'false'
    uses: ./.github/workflows/mimir-build-mcp-bridge.yml

  # Deploy backend
  deploy-backend:
    if: github.event.inputs.deploy_backend != 'false'
    needs: [build-backend]
    uses: ./.github/workflows/copilot-deploy-backend.yml
    with:
      ARTIFACT_NAME: ${{ needs.build-backend.outputs.artifact }}
      ENVIRONMENT: production
      DEPLOYMENT_NAME: SK-Copilot-NPI-MIMIR
    secrets: inherit

  # Deploy memorypipeline
  deploy-memorypipeline:
    needs: [build-memorypipeline]
    uses: ./.github/workflows/copilot-deploy-memorypipeline.yml
    with:
      ARTIFACT_NAME: memorypipeline
      ENVIRONMENT: production
      DEPLOYMENT_NAME: SK-Copilot-NPI-MIMIR
    secrets: inherit

  # Deploy MCP Bridge
  deploy-mcp-bridge:
    if: github.event.inputs.deploy_mcp_bridge != 'false'
    needs: [build-mcp-bridge]
    uses: ./.github/workflows/mimir-deploy-mcp-bridge.yml
    with:
      ARTIFACT_NAME: mcp-bridge
      ENVIRONMENT: production
    secrets: inherit

  # Configure WebAPI plugins and settings
  configure-webapi:
    needs: [deploy-backend]
    runs-on: ubuntu-latest
    if: ${{ needs.deploy-backend.result == 'success' }}
    steps:
      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure API Keys (from secrets)
        run: |
          WEBAPP_NAME="app-copichat-4kt5uxo2hrzri-webapi"

          echo "ðŸ” Configuring API keys from GitHub Secrets..."
          
          # Only set if the secret exists and is not empty
          SETTINGS=""
          
          if [ -n "${{ secrets.AZURE_AI_SEARCH_API_KEY }}" ]; then
            SETTINGS="$SETTINGS LeiarKontekst__ApiKey=${{ secrets.AZURE_AI_SEARCH_API_KEY }}"
            SETTINGS="$SETTINGS MimirKnowledge__ApiKey=${{ secrets.AZURE_AI_SEARCH_API_KEY }}"
            echo "  âœ“ Azure AI Search API key configured"
          fi
          
          if [ -n "${{ secrets.SHAREPOINT_CLIENT_SECRET }}" ]; then
            SETTINGS="$SETTINGS SharePointObo__ClientSecret=${{ secrets.SHAREPOINT_CLIENT_SECRET }}"
            echo "  âœ“ SharePoint client secret configured"
          fi
          
          if [ -n "$SETTINGS" ]; then
            az webapp config appsettings set \
              --resource-group ${{vars.CC_DEPLOYMENT_GROUP_NAME}} \
              --name $WEBAPP_NAME \
              --settings $SETTINGS \
              --output none
            echo "âœ… API keys configured"
          else
            echo "âš ï¸ No API key secrets found - configure manually in Azure Portal"
          fi

      - name: Configure Plugin Settings
        run: |
          WEBAPP_NAME="app-copichat-4kt5uxo2hrzri-webapi"

          echo "ðŸ“¦ Configuring LeiarKontekst plugin..."
          az webapp config appsettings set \
            --resource-group ${{vars.CC_DEPLOYMENT_GROUP_NAME}} \
            --name $WEBAPP_NAME \
            --settings \
              LeiarKontekst__Enabled="true" \
              LeiarKontekst__Endpoint="https://acs-copichat-4kt5uxo2hrzri.search.windows.net" \
              LeiarKontekst__IndexName="leiar-dokumenter" \
              LeiarKontekst__SemanticConfigurationName="leiar-semantic-config" \
              LeiarKontekst__MaxResults="5" \
              LeiarKontekst__MaxContentLength="30000" \
              LeiarKontekst__ContentFieldName="content" \
              LeiarKontekst__TitleFieldName="title" \
              LeiarKontekst__SourceFieldName="source" \
              LeiarKontekst__RequireApproval="false" \
            --output none

          echo "ðŸ“¦ Configuring MimirKnowledge plugin..."
          az webapp config appsettings set \
            --resource-group ${{vars.CC_DEPLOYMENT_GROUP_NAME}} \
            --name $WEBAPP_NAME \
            --settings \
              MimirKnowledge__Enabled="true" \
              MimirKnowledge__Endpoint="https://acs-copichat-4kt5uxo2hrzri.search.windows.net" \
              MimirKnowledge__IndexName="mimir-knowledge" \
              MimirKnowledge__SemanticConfigurationName="mimir-semantic-config" \
              MimirKnowledge__MaxResults="5" \
              MimirKnowledge__MaxContentLength="15000" \
              MimirKnowledge__ContentFieldName="content" \
              MimirKnowledge__TitleFieldName="title" \
              MimirKnowledge__SourceFieldName="source" \
              MimirKnowledge__CategoryFieldName="category" \
              MimirKnowledge__RequireApproval="false" \
            --output none

          echo "ðŸ“¦ Configuring SharePointObo plugin..."
          az webapp config appsettings set \
            --resource-group ${{vars.CC_DEPLOYMENT_GROUP_NAME}} \
            --name $WEBAPP_NAME \
            --settings \
              SharePointObo__Enabled="true" \
              SharePointObo__Authority="https://login.microsoftonline.com" \
              SharePointObo__TenantId="5b14945b-0f87-40dd-acf3-5e5e21e6eb36" \
              SharePointObo__ClientId="db0932b4-3bb7-4b89-a398-85be5940e84f" \
              SharePointObo__SiteUrl="https://vlfksky.sharepoint.com/sites/HR-kvalitet-HMS" \
              SharePointObo__DefaultScopes="https://graph.microsoft.com/Sites.Read.All https://graph.microsoft.com/Files.Read.All" \
              SharePointObo__MaxContentLength="50000" \
              SharePointObo__RequireApproval="false" \
            --output none

          echo "ðŸ“¦ Configuring Lovdata plugin..."
          az webapp config appsettings set \
            --resource-group ${{vars.CC_DEPLOYMENT_GROUP_NAME}} \
            --name $WEBAPP_NAME \
            --settings \
              Lovdata__Enabled="true" \
              Lovdata__BaseUrl="https://api.lovdata.no" \
              Lovdata__MaxContentLength="50000" \
              Lovdata__MaxResults="20" \
              Lovdata__TimeoutSeconds="30" \
              Lovdata__RequireApproval="false" \
            --output none

          echo "âœ… Plugin settings configured"

      - name: Configure Core Settings
        run: |
          WEBAPP_NAME="app-copichat-4kt5uxo2hrzri-webapi"

          echo "âš™ï¸ Configuring core settings..."
          az webapp config appsettings set \
            --resource-group ${{vars.CC_DEPLOYMENT_GROUP_NAME}} \
            --name $WEBAPP_NAME \
            --settings \
              FastModel__Enabled="true" \
              FastModel__Deployment="gpt-4o-mini" \
              Service__SemanticPluginsDirectory="./Plugins/SemanticPlugins" \
              Service__NativePluginsDirectory="./Plugins/NativePlugins" \
              DocumentMemory__DocumentLineSplitMaxTokens="72" \
              DocumentMemory__DocumentChunkMaxTokens="512" \
              DocumentMemory__FileSizeLimit="10000000" \
              DocumentMemory__FileCountLimit="20" \
              RateLimiting__Enabled="true" \
              RateLimiting__MessagesPerMinute="20" \
              RateLimiting__MessagesPerHour="200" \
              RateLimiting__ConcurrentRequestsPerUser="5" \
              RateLimiting__GlobalRequestsPerMinute="1000" \
              Models__DefaultModelId="gpt-5.2-chat" \
            --output none

          echo "âœ… Core settings configured"

  # Configure MCP Bridge URL (only if MCP bridge is deployed)
  configure-mcp:
    needs: [configure-webapi, deploy-mcp-bridge]
    runs-on: ubuntu-latest
    if: ${{ needs.deploy-mcp-bridge.result == 'success' }}
    steps:
      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure MCP Bridge
        run: |
          WEBAPP_NAME="app-copichat-4kt5uxo2hrzri-webapi"
          MCP_URL="${{needs.deploy-mcp-bridge.outputs.mcp-bridge-url}}"

          echo "ðŸ”Œ Configuring MCP Bridge at ${MCP_URL}..."
          az webapp config appsettings set \
            --resource-group ${{vars.CC_DEPLOYMENT_GROUP_NAME}} \
            --name $WEBAPP_NAME \
            --settings \
              McpServers__PlanApprovalMode="PerServer" \
              McpServers__Servers__0__Url="${MCP_URL}/mcp" \
              McpServers__Servers__0__Name="CustomMcpServer" \
              McpServers__Servers__0__Enabled="true" \
              McpServers__Servers__0__TimeoutSeconds="120" \
              McpServers__Servers__0__RequireApproval="true" \
              McpServers__Servers__0__Description="KlarsprÃ¥k MCP server - provides text analysis and simplification tools" \
              McpServers__Servers__0__Templates__0="klarsprak" \
            --output none

          echo "âœ… MCP Bridge configured"

      - name: Restart WebAPI
        run: |
          WEBAPP_NAME="app-copichat-4kt5uxo2hrzri-webapi"

          az webapp restart \
            --resource-group ${{vars.CC_DEPLOYMENT_GROUP_NAME}} \
            --name $WEBAPP_NAME

          echo "âœ… WebAPI restarted"

  # Summary
  deployment-summary:
    needs:
      [
        deploy-backend,
        deploy-memorypipeline,
        deploy-mcp-bridge,
        configure-webapi,
        configure-mcp,
      ]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "# ðŸš€ Mimir Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Memorypipeline | ${{ needs.deploy-memorypipeline.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MCP Bridge | ${{ needs.deploy-mcp-bridge.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Plugin Config | ${{ needs.configure-webapi.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MCP Config | ${{ needs.configure-mcp.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group**: ${{ vars.CC_DEPLOYMENT_GROUP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**MCP Bridge URL**: ${{ needs.deploy-mcp-bridge.outputs.mcp-bridge-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”Œ Configured Plugins" >> $GITHUB_STEP_SUMMARY
          echo "- LeiarKontekst (Azure AI Search)" >> $GITHUB_STEP_SUMMARY
          echo "- MimirKnowledge (Azure AI Search)" >> $GITHUB_STEP_SUMMARY
          echo "- SharePointObo (Microsoft Graph)" >> $GITHUB_STEP_SUMMARY
          echo "- Lovdata (Norwegian Laws API)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Note:** API keys must be configured separately in Azure Portal or via secrets." >> $GITHUB_STEP_SUMMARY
