name: Deploy Mimir to Production

on:
  push:
    branches:
      - main
    paths:
      - "webapi/**"
      - "webapp/**"
      - "mcp-bridge/**"
      - ".github/workflows/mimir-deploy-*.yml"
  workflow_dispatch:
    inputs:
      deploy_mcp_bridge:
        description: "Deploy MCP Bridge"
        required: false
        type: boolean
        default: true
      deploy_backend:
        description: "Deploy Backend"
        required: false
        type: boolean
        default: true
      deploy_frontend:
        description: "Deploy Frontend"
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  id-token: write

jobs:
  # Build backend
  build-backend:
    if: github.event.inputs.deploy_backend != 'false'
    uses: ./.github/workflows/copilot-build-backend.yml

  # Build frontend
  build-frontend:
    if: github.event.inputs.deploy_frontend != 'false'
    uses: ./.github/workflows/copilot-build-frontend.yml

  # Build memorypipeline
  build-memorypipeline:
    uses: ./.github/workflows/copilot-build-memorypipeline.yml

  # Build MCP bridge
  build-mcp-bridge:
    if: github.event.inputs.deploy_mcp_bridge != 'false'
    uses: ./.github/workflows/mimir-build-mcp-bridge.yml

  # Deploy infrastructure
  deploy-infra:
    needs: []
    uses: ./.github/workflows/copilot-deploy-infra.yml
    with:
      ENVIRONMENT: production
    secrets: inherit

  # Deploy backend
  deploy-backend:
    if: github.event.inputs.deploy_backend != 'false'
    needs: [build-backend, deploy-infra]
    uses: ./.github/workflows/copilot-deploy-backend.yml
    with:
      ARTIFACT_NAME: backend
      ENVIRONMENT: production
      DEPLOYMENT_NAME: ${{ needs.deploy-infra.outputs.deployment-id }}
    secrets: inherit

  # Deploy memorypipeline
  deploy-memorypipeline:
    needs: [build-memorypipeline, deploy-infra]
    uses: ./.github/workflows/copilot-deploy-memorypipeline.yml
    with:
      ARTIFACT_NAME: memorypipeline
      ENVIRONMENT: production
      DEPLOYMENT_NAME: ${{ needs.deploy-infra.outputs.deployment-id }}
    secrets: inherit

  # Deploy MCP Bridge
  deploy-mcp-bridge:
    if: github.event.inputs.deploy_mcp_bridge != 'false'
    needs: [build-mcp-bridge, deploy-infra]
    uses: ./.github/workflows/mimir-deploy-mcp-bridge.yml
    with:
      ARTIFACT_NAME: mcp-bridge
      ENVIRONMENT: production
    secrets: inherit

  # Update WebAPI with MCP Bridge URL
  configure-webapi:
    needs: [deploy-backend, deploy-mcp-bridge, deploy-infra]
    runs-on: ubuntu-latest
    if: ${{ needs.deploy-mcp-bridge.result == 'success' }}
    steps:
      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{vars.AZURE_GITHUB_ACCESS_APP_ID}}
          tenant-id: ${{vars.AZURE_GITHUB_ACCESS_TENANT_ID}}
          subscription-id: ${{vars.AZURE_GITHUB_ACCESS_SUB_ID}}

      - name: Update WebAPI Configuration
        run: |
          # Get WebAPI name
          WEBAPP_NAME=$(az deployment group show \
            --name ${{needs.deploy-infra.outputs.deployment-id}} \
            --resource-group ${{vars.CC_DEPLOYMENT_GROUP_NAME}} \
            --query properties.outputs.webapiName.value -o tsv)

          # Update MCP Server URL
          MCP_URL="${{needs.deploy-mcp-bridge.outputs.mcp-bridge-url}}"

          az webapp config appsettings set \
            --resource-group ${{vars.CC_DEPLOYMENT_GROUP_NAME}} \
            --name $WEBAPP_NAME \
            --settings \
              McpServers__Servers__0__Url="${MCP_URL}/mcp" \
              McpServers__Servers__0__Name="CustomMcpServer" \
              McpServers__Servers__0__Enabled="true" \
              McpServers__Servers__0__TimeoutSeconds="120" \
            --output none

          echo "âœ… WebAPI configured to use MCP Bridge at ${MCP_URL}"

      - name: Restart WebAPI
        run: |
          WEBAPP_NAME=$(az deployment group show \
            --name ${{needs.deploy-infra.outputs.deployment-id}} \
            --resource-group ${{vars.CC_DEPLOYMENT_GROUP_NAME}} \
            --query properties.outputs.webapiName.value -o tsv)

          az webapp restart \
            --resource-group ${{vars.CC_DEPLOYMENT_GROUP_NAME}} \
            --name $WEBAPP_NAME

          echo "âœ… WebAPI restarted"

  # Summary
  deployment-summary:
    needs:
      [
        deploy-infra,
        deploy-backend,
        deploy-memorypipeline,
        deploy-mcp-bridge,
        configure-webapi,
      ]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "# ðŸš€ Mimir Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ${{ needs.deploy-infra.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Memorypipeline | ${{ needs.deploy-memorypipeline.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MCP Bridge | ${{ needs.deploy-mcp-bridge.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | ${{ needs.configure-webapi.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment ID**: ${{ needs.deploy-infra.outputs.deployment-id }}" >> $GITHUB_STEP_SUMMARY
          echo "**MCP Bridge URL**: ${{ needs.deploy-mcp-bridge.outputs.mcp-bridge-url }}" >> $GITHUB_STEP_SUMMARY
